# 调试记录

```python
hidden_states:
# 2 维：x * y
tensor([[ 0.1543,  2.1094, -0.7891,  ...,  1.6719,  2.2656, -3.4062],
        [ 3.4375,  0.6172,  4.6875,  ..., -1.5469, -0.4453, -3.6562],
        [ 0.4590, -2.2500, -4.5312,  ..., -2.4375, -0.7031, -2.7500],
        ...,
        [-1.2344,  5.1562, -1.7031,  ..., -0.3691,  1.1641, -0.5742],
        [-1.9531,  3.7969, -0.7969,  ...,  3.6094,  0.9297, -0.2520],
        [-0.6602,  2.3438, -6.4062,  ...,  1.4453, -1.5078,  0.8789]],
       device='npu:0', dtype=torch.bfloat16)


# _prune_hidden_states()
hidden_states.index_select(0, sampling_metadata.selected_token_indices)
# 0, 21
# 即选第 21 行
tensor([[-0.6602,  2.3438, -6.4062,  ...,  1.4453, -1.5078,  0.8789]],
       device='npu:0', dtype=torch.bfloat16)


logits = self._get_logits(hidden_states, lm_head, embedding_bias)
tensor([[9.8125, 6.7188, 4.4062,  ..., 0.7695, 0.7695, 0.7695]],
       device='npu:0', dtype=torch.bfloat16)
# Remove paddings in vocab (if any).
tensor([[9.8125, 6.7188, 4.4062,  ..., 0.7695, 0.7695, 0.7695]],
       device='npu:0', dtype=torch.bfloat16)
# self.org_vocab_size = 152064

# seq_group
[SequenceGroupToSample(seq_ids=[0], sampling_params=SamplingParams(n=1, presence_penalty=0.0, frequency_penalty=0.0, repetition_penalty=1.0, temperature=1.0, top_p=1.0, top_k=-1, min_p=0.0, seed=None, stop=[], stop_token_ids=[151643], bad_words=[], include_stop_str_in_output=False, ignore_eos=False, max_tokens=16, min_tokens=0, logprobs=None, prompt_logprobs=None, skip_special_tokens=True, spaces_between_special_tokens=True, truncate_prompt_tokens=None, guided_decoding=None), seq_data={0: SequenceData(prompt_token_ids=array('l', [31115, 264, 4718, 448, 279, 6741, 11, 1614, 323, 1803, 1819, 315, 1782, 1429, 26277, 1803, 504, 279, 220, 24, 15, 594]), output_token_ids=(), cumulative_logprob=0.0, get_num_computed_tokens=0)}, seq_len=22, query_len=22, generator=None, is_prompt=True, prompt_logprob_indices=[], sample_indices=[0])]

# logits_row = logits[logits_row_idx]
tensor([9.8125, 6.7188, 4.4062,  ..., 0.7695, 0.7695, 0.7695], device='npu:0',
       dtype=torch.bfloat16)
# sampling_metadata.seq_groups[0].seq_data[0].prompt_token_ids
(31115, 264, 4718, 448, 279, 6741, 11, 1614, 323, 1803, 1819, 315, 1782, 1429, 26277, 1803, 504, 279, 220, 24, 15, 594)
# past_tokens_ids
()

logits_row = logits_processor(past_tokens_ids, logits_row)
# class BaseLogitsProcessor: __call__(input_ids, scores)
# allowed_tokens:
tensor([4913, 90], device='npu:0')
# mask
tensor([-inf, -inf, -inf,  ..., -inf, -inf, -inf], device='npu:0')
mask.index_fill_(0, allowed_tokens, 0)

# output
SamplerOutput(outputs=[CompletionSequenceGroupOutput(samples=[SequenceOutput(parent_seq_id=0, output_token=4913, logprobs={4913: Logprob(logprob=inf, rank=None, decoded_token=None)})], prompt_logprobs=None)], sampled_token_probs=None, sampled_token_ids=None, spec_decode_worker_metrics=None)

tensor([ 28700,  21871,  51517,  47012,   8067,  96132,  15553,   5962,  56390,
         35973,  19845,  21299,  33579,   2917,  15197,  88947,  84588,  56323,
          9749,  40919,  63590,  25372,  42884,  92366,  13022,  86191,  98398,
         40271,  65120,  83213,  37366,  63307,  20584,  84743,  30975,  59967,
         14482,  67961,  39915,  32213,  36864,  31486,  22476,  92667,  76682,
         52052,  66294,   7005,  13399,  12310,  14345,  53074,  63392,  14129,
         73637,  17834,  75091,  67681,   3014,   1341,  14786,  30917,  84031,
         98419,  75894,  70154,  77199,  57439,  60420,  60347,  47705,  80548,
         87596,  94863,   5201,  82729,  96171,  35574,  34482,  13265,  24894,
         27510,  89199,  58315,  71471,  39425,  65001,  91599,  73144,  38838,
         66896,  36234,  86224,  78522,   5572,  67334,   3975,   9207,  91386,
         98434,  54984,  94875,  77728,  27738,  68937,  43869,  76855,  45539,
         57676,   7178,  38713,  77223,  66251,  32973, 130048,  69378,  52812,
         62911,  32468,  59498,  64657,   9000,  14013,  88706,  35668,  32596,
          3263,  44970,  75197,   7914,  10022,  80575,  94090,   7044,  73527,
         16891,  10208,  35674,  45916,  38363,  39744,  62923,  72006,  82978,
          2761,  37639,  68882,  31391,   8428,  58640,  72155,  11993,  71720,
         38369,  81238,  77098,   7342,  90105,  73466,  57551,  14104,  68514,
         45058,  10545,  57557,   1827,  69183,  78993,  36778,  75942,  79936,
         83498,  22317,  34600,  48188,  21520,  80377,  40124,  62722,  86555,
         96946,   6630,   2198,  45140,  56693,  54734,  59312,  85615,  48340,
         26326,  32139,  86561,  40787,  66582,  91650,  73630,  78427,  39917,
         82424,  21608,  67455,  57721,  66150,    899,  11147,  23427,  10713,
          3521,  36799,  24011,   8899,  17982,  65575,  30408,   3670,  70591,
         56641,  91227,    330,  28957,  30630,   2000,   5924,  70959,  51269,
         74448,  65438,  74013,  35503,  54977,  37827,   5933,  67622,  97049,
         62609,  28096,  61593,  74022,  67993,   5869,   6523,  15898,  77660,
         96334,  90013,   8634,    497,  95029,  25203,  70688,  51725,  25495,
         66621,  96848,  36105,  31308,  77885,  70329,  35089,  37051,  96270,
         92200,  29133,  41413,  27533,  81155,  59719,  20634,  27244,  31673,
         29209,  83777,  43664,  68300,  61541,  41553,  31682,  26523,    220,
         98603,  88720,  59658,  44470,  40622,      1,  15630,  56321,  80154,
         52035,  76522,  44917,  21522,  95345,  12077,  90624,  22760,  33732,
         78128,  11934,  45650,  26468,  46958,  38459,  92446,  71667,  75664,
         23131,  80169,  60260,  48199,  17756,  42097,  86490,  32725,    755,
         18121,  83661,  86931,  30693,  61428,  10857,  46316,  63028,  47189,
         78797,  22486,  36509,   5038,  65720,   3088,   5123,  50681,  45014,
         30337,  52570,  14717,  82727,  86143,  97115,  26708,  96826,  66310,
         13123,  82368,  11018,  63624,  87965,  94797,  67186,  78304,  57741,
         59849,  32603,  98651,  54401,  95092,  70316,  67411,   8992,   3252,
         47140,  67049,  42200,  76932,  73735,  38422,   4055,  33628,  59128,
         67779,  17135,  58407,  75192,  18081,    788,  13868,   3115,  65893,
         53905,  83405,  47219,   1591,  74757,  13366,  34802,  77817,  34294,
         79925,  18963,   5521], device='npu:0')

{"brand": "Porsche", "model": " nextState: 'success',
```
