# vLLM å­¦ä¹ ç¬”è®° ï½œ Guided Decoding

[toc]

## ä¸€ã€å¼•è¨€

â€¦â€¦

## äºŒã€ä»€ä¹ˆæ˜¯ Guided Decodingï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼ŒLLM çš„è¾“å‡ºé€šå¸¸æ˜¯ä¸€æ®µç¬¦åˆäººç±»è¡¨è¾¾ä¹ æƒ¯çš„æ–‡æœ¬åºåˆ—ï¼Œè¿™è®©æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ LLM æ¥å›ç­”é—®é¢˜æˆ–æ˜¯åˆ›ä½œå†…å®¹ã€‚ç„¶è€Œï¼Œå½“æˆ‘ä»¬éœ€è¦ LLM çš„è¾“å‡ºç¬¦åˆç‰¹å®šçš„æ ¼å¼ï¼ˆå¦‚ï¼šJSONã€SQLã€æ­£åˆ™è¡¨è¾¾å¼ç­‰ï¼‰æ—¶â€”â€”ä¾‹å¦‚å¸Œæœ› LLM æ ¹æ®æˆ‘ä»¬çš„éœ€æ±‚ç”ŸæˆæŸ¥è¯¢æ•°æ®åº“çš„ SQL è¯­å¥ï¼Œé€šè¿‡å¾®è°ƒçš„æ–¹æ³•é€šå¸¸å¾ˆéš¾è¾¾åˆ°æˆ‘ä»¬é¢„æœŸçš„æ•ˆæœã€‚è¿™æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ° Guided Decoding æŠ€æœ¯ï¼Œå®ƒå¯ä»¥é€šè¿‡å½±å“æ¨¡å‹è¾“å‡ºå±‚çš„ Logits åˆ†å¸ƒï¼ˆæ–½åŠ  Mask è¿‡æ»¤ä¸æ»¡è¶³è¦æ±‚çš„ Tokenï¼‰æ¥è¾¾åˆ°è§„èŒƒæ¨¡å‹è¾“å‡ºæ ¼å¼çš„æ•ˆæœã€‚

**ğŸŒ° ä¸¾ä¸ªä¾‹å­ï¼š**

æˆ‘ä»¬å¯ä»¥å‘ LLM è¾“å…¥ä¸€ä¸ª Prompt ä»¥åŠå¯¹åº”çš„æ ¼å¼æ•°æ®ï¼š

```python
# Guided decoding by JSON using Pydantic schema
class CarType(str, Enum):
    sedan = "sedan"
    suv = "SUV"
    truck = "Truck"
    coupe = "Coupe"


class CarDescription(BaseModel):
    brand: str
    model: str
    car_type: CarType


json_schema = CarDescription.model_json_schema()


prompt = ("Generate a JSON with the brand, model and car_type of"
          "the most iconic car from the 90's, think in 100 tokens")
```

æ­¤æ—¶ï¼ŒLLM å°±ä¼šæ ¹æ®æˆ‘ä»¬çš„è¦æ±‚ç”Ÿæˆä¸€ä¸ª JSON æ ¼å¼çš„è¾“å‡ºï¼š

```json
content: {
    "brand": "Levels",
    "model": "racing equation",
    "car_type": "sedan"
}
```

## ä¸‰ã€Outlines åŸç†è¯¦è§£

ç›®å‰ï¼Œå®ç°äº† Guided Decoding æ”¯æŒçš„åç«¯æœ‰ `outlines`ã€`xgrammar` ä»¥åŠ `lm-format-enforcer` ç­‰ï¼Œä¸‹é¢å°†ä»¥ Outlines ä¸ºä¾‹ï¼Œæ·±å…¥ä»‹ç» Guided Decoding èƒŒåçš„å®ç°åŸç†ã€‚

**Outlines çš„æ ¸å¿ƒæŠ€æœ¯ç‚¹åŒ…æ‹¬ï¼š**

- **åŸºäº FSMï¼ˆFinite-State Machineï¼Œæœ‰é™çŠ¶æ€æœºï¼‰**ï¼Œå®ç°äº†å½“å‰è¾“å…¥ä¸å¯¹åº”çŠ¶æ€çš„åŒ¹é…ï¼Œå¹¶å¯ä»¥æ ¹æ®çŠ¶æ€è½¬ç§»å‡½æ•°ç¡®å®šå¯¹åº”çš„ Maskï¼›
- **å»ºç«‹äº† FSM çš„çŠ¶æ€ä¸å…¶å¯æ¥å—è¾“å…¥çš„ Map**ï¼Œå¹¶ä¸ºè¿™äº› Token å»ºç«‹ç´¢å¼•ï¼Œä»è€Œé¿å…äº†åœ¨æ¯æ¬¡ Decode ä¸­éå†æ•´ä¸ª Vocabulary è¿›è¡ŒåŒ¹é…ï¼ŒåŠ å¿«äº†åŒ¹é…çš„é€Ÿåº¦ã€‚

ä¸‹é¢ï¼Œä¸ºäº†è®©å¤§å®¶æ›´å¿«é€Ÿã€æ›´ç›´è§‚åœ°ç†è§£ Outlines çš„åŸç†ï¼Œæœ¬æ–‡å°†å°½åŠ›é¿å…å¤§æ®µå…¬å¼å’Œç®—æ³•çš„ç½—åˆ—ï¼Œè€Œæ˜¯å°½é‡ä½¿ç”¨å…·ä½“çš„ä¾‹å­è¿›è¡Œè®²è§£ã€‚

### 3.1 FSM çš„å·¥ä½œåŸç†

**ğŸŒ° ä¸¾ä¸ªä¾‹å­ï¼š**

å‡è®¾æˆ‘ä»¬éœ€è¦æ¨¡å‹è¾“å‡ºä¸€ä¸ªæµ®ç‚¹å°æ•°ï¼Œå³è¾“å‡ºéœ€è¦åŒ¹é…çš„æ­£åˆ™è¡¨è¾¾å¼ä¸º `([0-9]*)?\.?[0-9]*`ï¼Œå¹¶ç»™å®šä¸€ä¸ªä»…åŒ…å« `A`ã€`.`ã€`42`ã€`.2` å’Œ `1` çš„ Vocabularyã€‚

> â€œæ­£åˆ™è¡¨è¾¾å¼â€ç¬¦å·è¯´æ˜ï¼š
>
> - `*`ï¼šåŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–å¤šæ¬¡ï¼›
> - `?`ï¼šåŒ¹é…å‰é¢çš„å­è¡¨è¾¾å¼é›¶æ¬¡æˆ–ä¸€æ¬¡ï¼›
> - `.`ï¼šåŒ¹é…é™¤æ¢è¡Œç¬¦ `\n` ä¹‹å¤–çš„ä»»ä½•å•å­—ç¬¦ï¼›
> - `\.`ï¼šåŒ¹é…å°æ•°ç‚¹ç¬¦å· `.`ï¼ˆéœ€è¦ä½¿ç”¨ `\` è¿›è¡Œè½¬ä¹‰ï¼‰ã€‚

å½“ LLM å¼€å§‹ Decode æ—¶ï¼ŒFSM ä½äºåˆå§‹çŠ¶æ€ï¼ˆ`0`ï¼Œç”¨æ•´æ•°è¡¨ç¤ºä¸åŒçš„çŠ¶æ€ï¼‰ï¼Œæ ¹æ®çŠ¶æ€ `0` çš„è½¬ç§»å‡½æ•°å¯çŸ¥ï¼Œå½“å‰çŠ¶æ€å¯ä»¥æ¥å—çš„å­—ç¬¦æ¨¡å¼ä¸º `[0-9]` å’Œ `[.]`ï¼Œè€Œåœ¨æˆ‘ä»¬æ‰€ç»™çš„è¯è¡¨ä¸­ï¼Œåªæœ‰ `A` ä¸ç¬¦åˆï¼Œæ­¤æ—¶ FSM ä¼šé’ˆå¯¹è¯è¡¨ `['A', '.', '42', '.2', '1']` ç”Ÿæˆä¸€ä¸ªå€¼ä¸º `[0, 1, 1, 1, 1]` çš„ Maskï¼Œå³æ¨¡å‹åœ¨æœ¬è½®è¿­ä»£è¿›è¡Œé‡‡æ ·æ—¶ä¼šæ’é™¤æ‰ `A`ï¼ˆå›¾ä¸­ç”¨é»‘è‰²è¡¨ç¤ºï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![](./images/outlines-fsm.png)

æ¥ä¸‹æ¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š

1. **æ¨¡å‹æœ¬è½®çš„é‡‡æ ·å€¼ä¸º `.2`ï¼ˆå›¾ä¸­ç”¨çº¢è‰²è¡¨ç¤ºï¼‰**ï¼Œæ­¤æ—¶ `.2` åŒæ—¶æ»¡è¶³ä»çŠ¶æ€ `0` è¿‡æ¸¡åˆ°çŠ¶æ€ `2` å†åˆ°çŠ¶æ€ `3` çš„æ¡ä»¶ï¼Œå› æ­¤ FSM çš„å½“å‰çŠ¶æ€ä¼šè·³è½¬åˆ°çŠ¶æ€ `3` å¹¶ç”Ÿæˆä¸‹ä¸€æ¬¡é‡‡æ ·çš„ Maskã€‚ç”±äºçŠ¶æ€ `3` å¯æ¥å—çš„å­—ç¬¦æ¨¡å¼ä»…ä¸º `[0-9]`ï¼Œåªæœ‰ `42` å’Œ `1` æ»¡è¶³ï¼Œå› æ­¤æ­¤æ—¶çš„ Mask ä¸º `[0, 0, 1, 0, 1]`ï¼›
2. **æ¨¡å‹æœ¬è½®çš„é‡‡æ ·å€¼ä¸º `1`ï¼ˆå›¾ä¸­ç”¨é»„è‰²è¡¨ç¤ºï¼‰**ï¼ŒåŒç†ï¼Œæ­¤æ—¶ FSM ä¼šè·³è½¬åˆ°çŠ¶æ€ `1` å¹¶ç”Ÿæˆå¯¹åº”çš„ Maskï¼Œå…¶å€¼ä¸º `[0, 1, 1, 1, 1]`ã€‚

ä¸æ–­å¾ªç¯æ­¤è¿‡ç¨‹ï¼Œæœ€ç»ˆå°±èƒ½å¾—åˆ°æ»¡è¶³è¯¥æ­£åˆ™è¡¨è¾¾å¼çš„è¾“å‡ºã€‚

> è¡¥å……ï¼šåœ¨ vLLM çš„å®ç°ä¸­ï¼Œå…¶ Mask ä½¿ç”¨ `0` è¡¨ç¤ºæ¥å—çš„ Tokenï¼Œç”¨ `-inf`ï¼ˆè´Ÿæ— ç©·ï¼‰è¡¨ç¤ºè¦æ’é™¤çš„ Tokenï¼Œç„¶åå†å°†è¾“å‡ºçš„ Logits åˆ†å¸ƒä¸ Mask ç›¸åŠ ï¼Œä»è€Œè¾¾åˆ°å±è”½ä¸æ»¡è¶³è¦æ±‚çš„ Token çš„æ•ˆæœã€‚

### 3.2 FSM çš„æ„å»ºè¿‡ç¨‹

åœ¨äº†è§£äº† Outlines ä¸­ FSM çš„åŸºæœ¬å·¥ä½œåŸç†ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å†çœ‹ä¸‹ï¼Œé’ˆå¯¹ä¸€ä¸ªç»™å®šçš„æ­£åˆ™è¡¨è¾¾å¼ä¸ Vocabularyï¼ŒOutlines æ˜¯å¦‚ä½•æ„å»ºè¿™ä¸ª FSM çš„ã€‚

è¿˜æ˜¯ä»¥ä¸Šé¢çš„ä¾‹å­è¿›è¡Œè¯´æ˜ï¼Œ

### 3.3 æ€»ç»“

æœ€åï¼ŒOutlines ä¸ä»…å¯ä»¥æ”¯æŒä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥é™å®šæ¨¡å‹çš„è¾“å‡ºï¼Œè¿˜æ”¯æŒ **CFGsï¼ˆContext-Free Grammarsï¼Œä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•ï¼‰**ï¼Œæ¯”å¦‚ï¼šJSONã€SQL ä»¥åŠ Python ç­‰è¯­è¨€ï¼Œå…³äºå…¶åŸç†è¿™é‡Œä¸å†è¯¦ç»†å±•å¼€å™è¿°ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»é˜…è¯» Outlines çš„[<u>è®ºæ–‡</u>](https://arxiv.org/abs/2307.09702)ä¸[<u>æºç </u>](https://github.com/dottxt-ai/outlines)ã€‚

## å››ã€vLLM Guided Decoding æºç è§£è¯»

â€¦â€¦

### æ€»ç»“

æ”¯æŒ Reasoningã€‚
[PR](https://github.com/vllm-project/vllm/pull/12955)
[Ce Gao](https://github.com/gaocegege)

## äº”ã€SGLang Jump-Forward Decoding

å¯¹æ¯” Outlines çš„ç¼ºç‚¹ã€‚

â€¦â€¦

## å…­ã€å‚è€ƒèµ„æ–™

- [<u>Robust Text-to-SQL Generation with Execution-Guided Decoding</u>](https://arxiv.org/abs/1807.03100)
- [<u>Efficient Guided Generation for Large Language Models</u>](https://arxiv.org/abs/2307.09702)
- [<u>vLLM Docs - Structured Outputs</u>](https://docs.vllm.ai/en/stable/features/structured_outputs.html#structured-outputs)
- [<u>Fast JSON Decoding for Local LLMs with Compressed Finite State Machine</u>](https://lmsys.org/blog/2024-02-05-compressed-fsm/)
