<mxfile host="Electron" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/26.0.4 Chrome/128.0.6613.186 Electron/32.2.5 Safari/537.36" version="26.0.4">
  <diagram name="第 1 页" id="bDiBdIQamMDJt9MmjTzO">
    <mxGraphModel dx="2603" dy="1502" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="0" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="21xvK6bFaa9k74VswOH4-6" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;FullAttentionSpec&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ num_kv_heads: int&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;head_size: int&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;dtype: torch.dtype&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;use_mla: bool&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="-290" y="1010" width="140" height="120" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-7" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b style=&quot;&quot;&gt;KVCacheSpec&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;border-style:solid;&quot; size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;block_size: int &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;number of tokens&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;border-style:solid;&quot; size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;@property&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;&quot;&gt;type_id(self) -&amp;gt; str&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;@property&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;font&gt;page_size_bytes(self) -&amp;gt; int&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;@property&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;bytes_for_tokens(self, num_tokens: int) -&amp;gt; int&lt;font&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="-360" y="730" width="280" height="200" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-8" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="21xvK6bFaa9k74VswOH4-6" edge="1">
          <mxGeometry x="-0.25" width="160" relative="1" as="geometry">
            <mxPoint x="-220.23000000000002" y="980" as="sourcePoint" />
            <mxPoint x="-220.23000000000002" y="930" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-9" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;KVCacheGroupSpec&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ layer_names: list[str]&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;kv_cache_spec: KVCacheSpec&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="-580" y="1010" width="200" height="90" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-10" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="21xvK6bFaa9k74VswOH4-9" edge="1">
          <mxGeometry x="-0.4667" width="160" relative="1" as="geometry">
            <mxPoint x="-440" y="850" as="sourcePoint" />
            <mxPoint x="-360" y="850" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-480" y="850" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-11" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;KVCacheTensor&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;size: int &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(of a layer)&lt;/font&gt;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="-290" y="1160" width="140" height="80" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-12" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;KVCacheConfig&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;num_blocks: int&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;tensors: dict[str, KVCacheTensor]&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;layer_name &amp;lt;--&amp;gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;how to initialize for that layer&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;kv_cache_groups: list[KVCacheGroupSpec]&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="-580" y="1290" width="500" height="110" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-14" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.201;exitY=-0.005;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitPerimeter=0;" parent="1" source="21xvK6bFaa9k74VswOH4-12" target="21xvK6bFaa9k74VswOH4-9" edge="1">
          <mxGeometry x="-0.1612" width="160" relative="1" as="geometry">
            <mxPoint x="-650" y="1280" as="sourcePoint" />
            <mxPoint x="-530" y="1120" as="targetPoint" />
            <Array as="points">
              <mxPoint x="-480" y="1210" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-15" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;" parent="1" edge="1">
          <mxGeometry x="-0.2" width="160" relative="1" as="geometry">
            <mxPoint x="-220" y="1290" as="sourcePoint" />
            <mxPoint x="-220" y="1240" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-16" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Request&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ request_id: str&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;prompt: Optional[str]&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;prompt_token_ids: list[int]&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;multi_modal_inputs: Optional[list[&quot;MultiModalKwargs&quot;]]&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;multi_modal_hashes: Optional[list[str]]&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;multi_modal_placeholders: Optional[list[&quot;PlaceholderRange&quot;]]&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;sampling_params: SamplingParams&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;eos_token_id: Optional[int]&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;arrival_time: float&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;lora_request: Optional[&quot;LoRARequest&quot;] = None&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;structured_output_request: Optional[&quot;StructuredOutputRequest&quot;] = None&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="1680" y="310" width="480" height="220" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-17" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RequestStatus&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ WAITING:&amp;nbsp;enum.IntEnum&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;RUNNING:&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;enum.IntEnum&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;PREEMPTED:&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;enum.IntEnum&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;FINISHED_XXX:&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;enum.IntEnum&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="2240" y="350" width="240" height="120" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-18" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1.001;exitY=0.455;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="21xvK6bFaa9k74VswOH4-16" target="21xvK6bFaa9k74VswOH4-17" edge="1">
          <mxGeometry x="-0.006" width="160" relative="1" as="geometry">
            <mxPoint x="2180" y="420" as="sourcePoint" />
            <mxPoint x="2300" y="550" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-19" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ModelRunnerOutput&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ req_ids: list[str]&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;req_id_to_index: dict[str, int]&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;sampled_token_ids: list[list[int]]&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;num_reqs x num_generated_tokens&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;spec_token_ids: Optional[list[list[int]]]&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;num_reqs x num_spec_tokens&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;logprobs: Optional[LogprobsLists]&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;token_ids, logprobs, ranks&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;prompt_logprobs_dict: dict[str, Optional[LogprobsTensors]]&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;req_id -&amp;gt; (token_ids, logprobs, ranks)&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="1680" y="610" width="600" height="150" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-20" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BlockPool&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ num_gpu_blocks: int&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;enable_caching: bool&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;blocks: list[KVCacheBlock]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;all kv-cache blocks&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;free_block_queue: FreeKVCacheBlockQueue&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;a doubly linked&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;list of free blocks&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;cached_block_hash_to_block: dict[BlockHashType, dict[&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;int, KVCacheBlock]]&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;{block_hash: {block ID: block}}&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;get_cached_block(self,&amp;nbsp;block_hash: BlockHashType) -&amp;gt; Optional[KVCacheBlock]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;cache_full_blocks(&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;self,&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...)&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;get_new_blocks(self, num_blocks: int) -&amp;gt; list[KVCacheBlock]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;touch(self, blocks: list[KVCacheBlock])&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(block.ref_cnt += 1)&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;free_blocks(self, ordered_blocks: Iterable[KVCacheBlock])&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;font style=&quot;background-color: transparent; color: rgb(153, 153, 153);&quot;&gt;(block.ref_cnt -= 1)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;get_usage(self) -&amp;gt; float&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;font style=&quot;background-color: transparent; color: rgb(153, 153, 153);&quot;&gt;(0 ~ 1)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry y="850" width="640" height="230" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-21" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;KVCacheBlock&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;block_id: int&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;ref_cnt: int = 0&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;-&amp;nbsp;_block_hash: Optional[BlockHashType]&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(block hash, tuple of token IDs)&lt;/font&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;+&amp;nbsp;prev_free_block: Optional[&quot;KVCacheBlock&quot;]&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;+&amp;nbsp;next_free_block: Optional[&quot;KVCacheBlock&quot;]&lt;/span&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;@property&lt;div&gt;&amp;nbsp;+&amp;nbsp;block_hash(self) -&amp;gt; Optional[BlockHashType]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(return self.&lt;span style=&quot;background-color: transparent;&quot;&gt;_block_hash&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;reset_hash(self)&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(reset the block hash when the block is evicted)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;&lt;/div&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry y="370" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-23" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;FreeKVCacheBlockQueue&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;blocks: list[KVCacheBlock]&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;num_free_blocks: int&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(= len(blocks))&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;-&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;free_list_head: Optional[KVCacheBlock]&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;+ free_list_tail: Optional[KVCacheBlock]&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry y="650" width="320" height="120" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-24" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" target="21xvK6bFaa9k74VswOH4-23" edge="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="159.76" y="850" as="sourcePoint" />
            <mxPoint x="159.76" y="800" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-25" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="159.77" y="650" as="sourcePoint" />
            <mxPoint x="160.01000000000002" y="570" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-26" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.563;exitY=0;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="400.0799999999997" y="850" as="sourcePoint" />
            <mxPoint x="400" y="570" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-27" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BlockHashType&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;hash_value: int&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;token_ids: tuple[int, ...]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(t&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;oken IDs in the block&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;-&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;extra_keys: Optional[Any] = None&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry y="180" width="320" height="110" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-28" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="159.76000000000002" y="370" as="sourcePoint" />
            <mxPoint x="160.00000000000003" y="290" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-29" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;KVCacheManager&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;block_size: int&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;num_gpu_blocks: int&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;max_model_len: int&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;sliding_window: Optional[int]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;enable_caching: bool&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;num_preallocate_tokens: int&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;log_stats: bool&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ block_pool: BlockPool&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;req_to_blocks: defaultdict[str,&amp;nbsp;list[KVCacheBlock]]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;req_to_block_hashes: defaultdict[&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;str, list[BlockHashType]]&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213)); background-color: transparent;&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;num_cached_block: dict[str, int]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;req_id &amp;lt;--&amp;gt; number of cached blocks)&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;get_computed_blocks(self, request) -&amp;gt; tuple[list[KVCacheBlock], int]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(blocks computed, number of tokens)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;allocate_slots(self,&amp;nbsp;request,&amp;nbsp;num_tokens,&amp;nbsp;new_computed_blocks) -&amp;gt; Optional[list[KVCacheBlock]]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;free(self, request)&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(free the blocks allocated for the request)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry y="1160" width="640" height="270" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-30" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0.5;entryY=1;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="319.57" y="1160" as="sourcePoint" />
            <mxPoint x="319.81" y="1080" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-31" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;Interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br&gt;&lt;b&gt;SchedulerInterface&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;border-style:solid;&quot; size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;&lt;hr style=&quot;border-style:solid;&quot; size=&quot;1&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;schedule(self) -&amp;gt; &quot;SchedulerOutput&quot;&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(s&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;chedule the requests to process&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;update_from_output(self, scheduler_output,&amp;nbsp;model_runner_output) -&amp;gt; &quot;EngineCoreOutputs&quot;&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(update the scheduler state)&lt;/font&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;add_request(self, request)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;finish_requests(self,&amp;nbsp;request_ids,&amp;nbsp;finished_status)&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;get_num_unfinished_requests(self) -&amp;gt; int&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;has_unfinished_requests(self) -&amp;gt; bool&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;has_finished_requests(self) -&amp;gt; bool&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;get_num_unscheduled_requests(self) -&amp;gt; int&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(requests that are not being processed)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;make_stats(self) -&amp;gt; Optional[&quot;SchedulerStats&quot;]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(is created every step)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="800" y="720" width="720" height="220" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-32" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;SchedulerOutput&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;scheduled_new_reqs: list[NewRequestData]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(are&amp;nbsp;&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;scheduled for the first time&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;scheduled_cached_reqs: list[CachedRequestData]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;have been scheduled before&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&amp;nbsp;num_scheduled_tokens: dict[str, int]&lt;span style=&quot;background-color: transparent;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;+&amp;nbsp;total_num_scheduled_tokens: int&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;+&amp;nbsp;finished_req_ids: set[str]&amp;nbsp; &lt;/span&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(finished in this step)&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="1680" y="840" width="480" height="150" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-33" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;NewRequestData&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;req_id: str&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;prompt_token_ids: list[int]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;prompt: Optional[str]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;mm_inputs: list[MultiModalKwargs]&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;mm_hashes: list[str]&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;mm_positions: list[PlaceholderRange]&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;sampling_params: SamplingParams&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;block_ids: list[int]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;num_computed_tokens: int&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;lora_request: Optional[LoRARequest]&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="2320" y="720" width="240" height="210" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-34" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;CachedRequestData&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;req_id: str&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;resumed_from_preemption: bool&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;new_token_ids: list[int]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;new_block_ids: list[int]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;num_computed_tokens: int&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="2320" y="950" width="240" height="140" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-35" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;EngineCoreOutputs&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;outputs: list[EngineCoreOutput] = []&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(len = num_reqs)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;color: rgb(20, 54, 66);&quot;&gt;+ scheduler_stats: Optional[SchedulerStats]&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="1680" y="1070" width="360" height="110" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-36" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;SchedulerStats&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;num_running_reqs: int&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;num_waiting_reqs: int&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;gpu_cache_usage: float&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;prefix_cache_stats: PrefixCacheStats&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="1680" y="1260" width="280" height="120" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-38" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=-0.003;entryY=0.577;entryDx=0;entryDy=0;exitX=1.001;exitY=0.455;exitDx=0;exitDy=0;exitPerimeter=0;entryPerimeter=0;" parent="1" target="21xvK6bFaa9k74VswOH4-33" edge="1">
          <mxGeometry x="-0.6657" width="160" relative="1" as="geometry">
            <mxPoint x="2160" y="920" as="sourcePoint" />
            <mxPoint x="2240" y="920" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2240" y="920" />
              <mxPoint x="2240" y="840" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-39" value="" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=-0.001;entryY=0.354;entryDx=0;entryDy=0;entryPerimeter=0;" parent="1" target="21xvK6bFaa9k74VswOH4-34" edge="1">
          <mxGeometry x="-0.6657" width="160" relative="1" as="geometry">
            <mxPoint x="2240" y="920" as="sourcePoint" />
            <mxPoint x="2320" y="841" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2240" y="1000" />
              <mxPoint x="2280" y="1000" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-43" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1.001;exitY=0.455;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" target="21xvK6bFaa9k74VswOH4-16" edge="1">
          <mxGeometry x="-0.8621" width="160" relative="1" as="geometry">
            <mxPoint x="1520" y="840" as="sourcePoint" />
            <mxPoint x="1600" y="840" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1600" y="840" />
              <mxPoint x="1600" y="420" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-44" value="" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry x="-0.006" width="160" relative="1" as="geometry">
            <mxPoint x="1600" y="840" as="sourcePoint" />
            <mxPoint x="1680" y="919.6599999999999" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1600" y="920" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-45" value="" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry x="-0.006" width="160" relative="1" as="geometry">
            <mxPoint x="1600" y="920" as="sourcePoint" />
            <mxPoint x="1680" y="1129.6599999999999" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1600" y="1130" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-46" value="" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry x="-0.006" width="160" relative="1" as="geometry">
            <mxPoint x="1600" y="1130" as="sourcePoint" />
            <mxPoint x="1680" y="1319.6599999999999" as="targetPoint" />
            <Array as="points">
              <mxPoint x="1600" y="1320" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-48" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" edge="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="800" y="1280.26" as="sourcePoint" />
            <mxPoint x="640" y="1280" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-49" value="&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1.001;exitY=0.455;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" edge="1">
          <mxGeometry x="-0.006" width="160" relative="1" as="geometry">
            <mxPoint x="1600" y="680" as="sourcePoint" />
            <mxPoint x="1680" y="680" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-50" value="" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;" parent="21xvK6bFaa9k74VswOH4-49" vertex="1" connectable="0">
          <mxGeometry x="0.0339" y="-7" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-51" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;Scheduler&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;scheduler_config: SchedulerConfig&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;cache_config: CacheConfig&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;requests: dict[str, Request]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;req_id &amp;lt;--&amp;gt; Request&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;waiting: deque[Request]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;running: list[Request]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;scheduled_req_ids: set[str]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(requests that have been scheduled and executed)&lt;/font&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+&amp;nbsp;finished_req_ids: set[str]&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;- _cached_reqs_data: dict[str, CachedRequestData]&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(req_id &amp;lt;--&amp;gt;&amp;nbsp;CachedRequestData)&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;schedule(self) -&amp;gt; SchedulerOutput&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;update_from_output(self,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;scheduler_output,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;model_runner_output)&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;-&amp;gt; EngineCoreOutputs&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;+ add_request(self, request)&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(to waiting queue)&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;finish_requests(self,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;request_ids,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;finished_status)&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(h&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;andles the finish signal from outside&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;get_num_unfinished_requests(self) -&amp;gt; int&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;font style=&quot;background-color: transparent; color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;/font&gt;&lt;font style=&quot;background-color: transparent; color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;len(waiting) + len(running)&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;has_finished_requests(self) -&amp;gt; bool&amp;nbsp; &lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;len(finished_req_ids) &amp;gt; 0&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;+&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;get_num_unscheduled_requests(self) -&amp;gt; int&amp;nbsp;&amp;nbsp;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;(&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;color: rgb(153, 153, 153);&quot;&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;len(waiting) + len(running) -&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;len(self.scheduled_req_ids)&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;)&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;...&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" parent="1" vertex="1">
          <mxGeometry x="800" y="1021" width="720" height="299" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-53" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" edge="1">
          <mxGeometry x="-0.25" width="160" relative="1" as="geometry">
            <mxPoint x="1159.98" y="1020" as="sourcePoint" />
            <mxPoint x="1159.75" y="940" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-54" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;waiting&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#b85450;fillColor=#f8cecc;" parent="1" vertex="1">
          <mxGeometry x="800" y="1530" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-55" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;running&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;" parent="1" vertex="1">
          <mxGeometry x="1040" y="1530" width="480" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-58" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;rotation=-90;" parent="1" vertex="1">
          <mxGeometry x="1270" y="1340" width="20" height="480" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-59" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;scheduled_req_ids&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="1215" y="1580" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-60" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;rotation=-90;" parent="1" vertex="1">
          <mxGeometry x="910" y="1460" width="20" height="240" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-61" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;unscheduled_requests&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="845" y="1580" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-62" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;waiting&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#b85450;fillColor=#f8cecc;" parent="1" vertex="1">
          <mxGeometry x="800" y="1660" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-63" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;new_running&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;" parent="1" vertex="1">
          <mxGeometry x="1040" y="1660" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-64" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;finished_req_ids&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#82b366;fillColor=#d5e8d4;" parent="1" vertex="1">
          <mxGeometry x="1280" y="1660" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-67" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;rotation=-90;" parent="1" vertex="1">
          <mxGeometry x="910" y="1590" width="20" height="240" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-68" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;unscheduled_requests&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="825" y="1710" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-70" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;strokeColor=#666666;fontColor=#143642;fillColor=#f5f5f5;endWidth=11.841165827179813;endSize=2.772027972027972;width=4.335664335664336;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1160" y="1610" as="sourcePoint" />
            <mxPoint x="1160" y="1650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-71" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;update_from_output()&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="1160" y="1610.99" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-73" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;prompt_token_ids&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#b85450;fillColor=#f8cecc;" parent="1" vertex="1">
          <mxGeometry x="1680" y="120" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-74" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;output_token_ids&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;" parent="1" vertex="1">
          <mxGeometry x="1920" y="120" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-75" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;spec_token_ids&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#82b366;fillColor=#d5e8d4;" parent="1" vertex="1">
          <mxGeometry x="2160" y="120" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-78" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;rotation=-90;" parent="1" vertex="1">
          <mxGeometry x="2030" y="-160" width="20" height="720" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-79" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;num_computed_tokens&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="1765" y="170" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-83" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;rotation=-90;" parent="1" vertex="1">
          <mxGeometry x="1830" y="10" width="20" height="320" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-84" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;num_tokens_with_spec&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="1965" y="200" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-85" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;rotation=-90;" parent="1" vertex="1">
          <mxGeometry x="2190" y="-30" width="20" height="400" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-86" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;num_new_tokens /&amp;nbsp;num_scheduled_tokens&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="2070" y="170" width="260" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-87" value="" style="endArrow=none;html=1;rounded=0;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1680" y="190" as="sourcePoint" />
            <mxPoint x="1680" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-89" value="" style="endArrow=none;html=1;rounded=0;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;" parent="1" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2400" y="190" as="sourcePoint" />
            <mxPoint x="2400" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-90" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;waiting&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#b85450;fillColor=#f8cecc;" parent="1" vertex="1">
          <mxGeometry x="800" y="1400" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-91" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;running&lt;/font&gt;" style="rounded=0;whiteSpace=wrap;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;" parent="1" vertex="1">
          <mxGeometry x="1160" y="1400" width="360" height="40" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-95" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;strokeColor=#000000;fontColor=#143642;fillColor=#FAE5C7;rotation=-90;" parent="1" vertex="1">
          <mxGeometry x="1150" y="1090" width="20" height="720" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-96" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;unscheduled_requests&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="1085" y="1450" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-97" value="" style="shape=flexArrow;endArrow=classic;html=1;rounded=0;strokeColor=#666666;fontColor=#143642;fillColor=#f5f5f5;endWidth=11.841165827179813;endSize=2.772027972027972;width=4.335664335664336;exitX=0;exitY=-0.033;exitDx=0;exitDy=0;exitPerimeter=0;" parent="1" source="21xvK6bFaa9k74VswOH4-98" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1160" y="1470" as="sourcePoint" />
            <mxPoint x="1160" y="1520" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-98" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;schedule()&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="1160" y="1480.99" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="21xvK6bFaa9k74VswOH4-99" value="&lt;b style=&quot;forced-color-adjust: none; color: rgb(20, 54, 66); font-family: &amp;quot;Comic Sans MS&amp;quot;; font-size: 12px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; white-space: normal; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial;&quot;&gt;Request:&lt;/b&gt;" style="text;whiteSpace=wrap;html=1;fontColor=#143642;" parent="1" vertex="1">
          <mxGeometry x="1680" y="80" width="80" height="30" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-1" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ModelRunner (V1)&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="2720" y="600" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-2" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;InputBatch&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="3040" y="600" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-3" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BlockTable&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="3280" y="600" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-4" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;CachedRequestState&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="3040" y="440" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-5" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AttentionMetadata&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="3040" y="760" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-6" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1.001;exitY=0.455;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" target="SPczmMSdJykSn1GW4YHU-2">
          <mxGeometry x="-0.5" width="160" relative="1" as="geometry">
            <mxPoint x="2880" y="639.8399999999999" as="sourcePoint" />
            <mxPoint x="2960" y="639.8399999999999" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-7" value="" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="2880" y="640" as="sourcePoint" />
            <mxPoint x="3040" y="480" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2960" y="640" />
              <mxPoint x="2960" y="480" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-8" value="" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=-0.011;entryY=0.522;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" source="SPczmMSdJykSn1GW4YHU-1" target="SPczmMSdJykSn1GW4YHU-5">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="2920" y="730" as="sourcePoint" />
            <mxPoint x="3020" y="780" as="targetPoint" />
            <Array as="points">
              <mxPoint x="2960" y="640" />
              <mxPoint x="2960" y="800" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-9" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1.001;exitY=0.455;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1">
          <mxGeometry x="-0.006" width="160" relative="1" as="geometry">
            <mxPoint x="3200" y="639.74" as="sourcePoint" />
            <mxPoint x="3280" y="639.74" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-10" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=1;entryY=0.2;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" target="21xvK6bFaa9k74VswOH4-19">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="2720" y="640" as="sourcePoint" />
            <mxPoint x="2290" y="640" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-11" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;WorkerBase (V0)&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="2720" y="-80" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-12" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;WorkerBase (V1)&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="2720" y="80" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-13" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;NPUWorker&lt;/b&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;&amp;nbsp;(V1)&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="2720" y="240" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-14" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="SPczmMSdJykSn1GW4YHU-13">
          <mxGeometry x="-0.006" width="160" relative="1" as="geometry">
            <mxPoint x="2799.64" y="520" as="sourcePoint" />
            <mxPoint x="2799.64" y="600" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-15" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="2799.87" y="240" as="sourcePoint" />
            <mxPoint x="2799.64" y="160" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-16" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="2799.87" y="80" as="sourcePoint" />
            <mxPoint x="2799.64" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-17" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;LocalOrDistributedWorkerBase&lt;/b&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;&amp;nbsp;(V0)&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="2960" y="80" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-18" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" target="SPczmMSdJykSn1GW4YHU-11">
          <mxGeometry x="-0.75" width="160" relative="1" as="geometry">
            <mxPoint x="3080.23" y="80" as="sourcePoint" />
            <mxPoint x="3080" as="targetPoint" />
            <mxPoint as="offset" />
            <Array as="points">
              <mxPoint x="3080" y="-40" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-19" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;NPUWorker&lt;/b&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;&amp;nbsp;(V0)&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="3000" y="240" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-20" value="Extends" style="endArrow=block;endSize=16;endFill=0;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="3079.78" y="240" as="sourcePoint" />
            <mxPoint x="3079.55" y="160" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-21" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;CacheEngine&lt;/b&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;r&lt;/b&gt;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; text-align: left;&quot;&gt;&lt;b&gt;&amp;nbsp;(V0)&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&lt;p style=&quot;margin:0px;margin-left:4px;&quot;&gt;+ ...&lt;/p&gt;&lt;hr size=&quot;1&quot; style=&quot;border-style:solid;&quot;&gt;&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(20, 54, 66), rgb(173, 202, 213));&quot;&gt;...&lt;/span&gt;" style="verticalAlign=top;align=left;overflow=fill;html=1;whiteSpace=wrap;strokeColor=#0F8B8D;fontColor=#143642;fillColor=#FAE5C7;labelBackgroundColor=none;fontFamily=Comic Sans MS;" vertex="1" parent="1">
          <mxGeometry x="3280" y="240" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-22" value="Use" style="endArrow=open;endSize=12;dashed=1;html=1;rounded=0;strokeColor=#A8201A;fontColor=#143642;fillColor=#FAE5C7;fontFamily=Comic Sans MS;entryX=0;entryY=0.5;entryDx=0;entryDy=0;exitX=1.001;exitY=0.455;exitDx=0;exitDy=0;exitPerimeter=0;" edge="1" parent="1" target="SPczmMSdJykSn1GW4YHU-21">
          <mxGeometry width="160" relative="1" as="geometry">
            <mxPoint x="3160" y="279.7" as="sourcePoint" />
            <mxPoint x="3240" y="279.7" as="targetPoint" />
            <Array as="points" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="SPczmMSdJykSn1GW4YHU-23" value="&lt;font face=&quot;Comic Sans MS&quot;&gt;Manage KVCache&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontColor=#143642;" vertex="1" parent="1">
          <mxGeometry x="3300" y="320" width="120" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
