# 多模态性能优化结果记录

## Baseline

Throughput benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Maximum request concurrency:             16        
Benchmark duration (s):                  206.06    
Total input tokens:                      33418     
Total generated tokens:                  61516     
Request throughput (req/s):              2.43      
Output token throughput (tok/s):         298.53    
Peak output token throughput (tok/s):    528.00    
Peak concurrent requests:                30.00     
Total token throughput (tok/s):          460.70    
---------------Time to First Token----------------
Mean TTFT (ms):                          945.18    
Median TTFT (ms):                        570.38    
P99 TTFT (ms):                           5986.31   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          45.69     
Median TPOT (ms):                        44.78     
P99 TPOT (ms):                           95.71     
---------------Inter-token Latency----------------
Mean ITL (ms):                           53.99     
Median ITL (ms):                         32.90     
P99 ITL (ms):                            383.97    
==================================================
```

Latency benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Request rate configured (RPS):           10.00     
Benchmark duration (s):                  82.09     
Total input tokens:                      33418     
Total generated tokens:                  61472     
Request throughput (req/s):              6.09      
Output token throughput (tok/s):         748.84    
Peak output token throughput (tok/s):    2945.00   
Peak concurrent requests:                407.00    
Total token throughput (tok/s):          1155.93   
---------------Time to First Token----------------
Mean TTFT (ms):                          10365.81  
Median TTFT (ms):                        6141.34   
P99 TTFT (ms):                           22606.41  
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          265.83    
Median TPOT (ms):                        277.96    
P99 TPOT (ms):                           611.59    
---------------Inter-token Latency----------------
Mean ITL (ms):                           254.68    
Median ITL (ms):                         95.97     
P99 ITL (ms):                            1787.15   
==================================================
```

## Merge rope q/k

Throughput benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Maximum request concurrency:             16        
Benchmark duration (s):                  205.65    
Total input tokens:                      33418     
Total generated tokens:                  61488     
Request throughput (req/s):              2.43      
Output token throughput (tok/s):         299.00    
Peak output token throughput (tok/s):    528.00    
Peak concurrent requests:                30.00     
Total token throughput (tok/s):          461.50    
---------------Time to First Token----------------
Mean TTFT (ms):                          817.56    
Median TTFT (ms):                        504.05    
P99 TTFT (ms):                           6109.81   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          46.78     
Median TPOT (ms):                        45.65     
P99 TPOT (ms):                           98.22     
---------------Inter-token Latency----------------
Mean ITL (ms):                           55.60     
Median ITL (ms):                         32.76     
P99 ITL (ms):                            343.66    
==================================================
```

Latency benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Request rate configured (RPS):           10.00     
Benchmark duration (s):                  82.12     
Total input tokens:                      33418     
Total generated tokens:                  61405     
Request throughput (req/s):              6.09      
Output token throughput (tok/s):         747.78    
Peak output token throughput (tok/s):    2562.00   
Peak concurrent requests:                406.00    
Total token throughput (tok/s):          1154.74   
---------------Time to First Token----------------
Mean TTFT (ms):                          10389.93  
Median TTFT (ms):                        6473.63   
P99 TTFT (ms):                           22290.72  
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          264.20    
Median TPOT (ms):                        276.27    
P99 TPOT (ms):                           533.26    
---------------Inter-token Latency----------------
Mean ITL (ms):                           253.49    
Median ITL (ms):                         95.76     
P99 ITL (ms):                            2016.82   
==================================================
```

## 并行 q/k/v pad

Throughput benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Maximum request concurrency:             16        
Benchmark duration (s):                  201.71    
Total input tokens:                      33418     
Total generated tokens:                  61544     
Request throughput (req/s):              2.48      
Output token throughput (tok/s):         305.11    
Peak output token throughput (tok/s):    532.00    
Peak concurrent requests:                29.00     
Total token throughput (tok/s):          470.78    
---------------Time to First Token----------------
Mean TTFT (ms):                          835.51    
Median TTFT (ms):                        560.38    
P99 TTFT (ms):                           6053.36   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          46.10     
Median TPOT (ms):                        43.92     
P99 TPOT (ms):                           98.57     
---------------Inter-token Latency----------------
Mean ITL (ms):                           53.68     
Median ITL (ms):                         32.92     
P99 ITL (ms):                            363.27    
==================================================
```

Latency benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Request rate configured (RPS):           10.00     
Benchmark duration (s):                  82.47     
Total input tokens:                      33418     
Total generated tokens:                  61667     
Request throughput (req/s):              6.06      
Output token throughput (tok/s):         747.76    
Peak output token throughput (tok/s):    2944.00   
Peak concurrent requests:                406.00    
Total token throughput (tok/s):          1152.98   
---------------Time to First Token----------------
Mean TTFT (ms):                          10584.73  
Median TTFT (ms):                        6462.94   
P99 TTFT (ms):                           22687.46  
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          256.92    
Median TPOT (ms):                        275.48    
P99 TPOT (ms):                           486.52    
---------------Inter-token Latency----------------
Mean ITL (ms):                           254.57    
Median ITL (ms):                         95.72     
P99 ITL (ms):                            1710.50   
==================================================
```

## cu_seqlens cpu cache

Throughput benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Maximum request concurrency:             16        
Benchmark duration (s):                  201.00    
Total input tokens:                      33418     
Total generated tokens:                  61527     
Request throughput (req/s):              2.49      
Output token throughput (tok/s):         306.11    
Peak output token throughput (tok/s):    528.00    
Peak concurrent requests:                30.00     
Total token throughput (tok/s):          472.37    
---------------Time to First Token----------------
Mean TTFT (ms):                          839.89    
Median TTFT (ms):                        501.68    
P99 TTFT (ms):                           6039.57   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          45.12     
Median TPOT (ms):                        44.53     
P99 TPOT (ms):                           95.00     
---------------Inter-token Latency----------------
Mean ITL (ms):                           52.78     
Median ITL (ms):                         32.34     
P99 ITL (ms):                            314.70    
==================================================
```

Latency benchmark:

Mean TTFT 3.34% ⬇️

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Request rate configured (RPS):           10.00     
Benchmark duration (s):                  81.69     
Total input tokens:                      33418     
Total generated tokens:                  61486     
Request throughput (req/s):              6.12      
Output token throughput (tok/s):         752.71    
Peak output token throughput (tok/s):    2789.00   
Peak concurrent requests:                401.00    
Total token throughput (tok/s):          1161.82   
---------------Time to First Token----------------
Mean TTFT (ms):                          10232.89  
Median TTFT (ms):                        6126.93   
P99 TTFT (ms):                           22129.56  
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          261.79    
Median TPOT (ms):                        273.48    
P99 TPOT (ms):                           517.72    
---------------Inter-token Latency----------------
Mean ITL (ms):                           251.91    
Median ITL (ms):                         93.85     
P99 ITL (ms):                            1786.99   
==================================================
```

## Revert pad

Throughput benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Maximum request concurrency:             16        
Benchmark duration (s):                  204.98    
Total input tokens:                      33418     
Total generated tokens:                  61485     
Request throughput (req/s):              2.44      
Output token throughput (tok/s):         299.96    
Peak output token throughput (tok/s):    513.00    
Peak concurrent requests:                30.00     
Total token throughput (tok/s):          463.00    
---------------Time to First Token----------------
Mean TTFT (ms):                          829.28    
Median TTFT (ms):                        482.38    
P99 TTFT (ms):                           5920.59   
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          46.75     
Median TPOT (ms):                        45.66     
P99 TPOT (ms):                           100.64    
---------------Inter-token Latency----------------
Mean ITL (ms):                           53.59     
Median ITL (ms):                         32.88     
P99 ITL (ms):                            306.12    
==================================================
```

Latency benchmark:

```
============ Serving Benchmark Result ============
Successful requests:                     500       
Failed requests:                         0         
Request rate configured (RPS):           10.00     
Benchmark duration (s):                  81.59     
Total input tokens:                      33418     
Total generated tokens:                  61509     
Request throughput (req/s):              6.13      
Output token throughput (tok/s):         753.88    
Peak output token throughput (tok/s):    2817.00   
Peak concurrent requests:                403.00    
Total token throughput (tok/s):          1163.47   
---------------Time to First Token----------------
Mean TTFT (ms):                          10096.28  
Median TTFT (ms):                        6131.27   
P99 TTFT (ms):                           21889.00  
-----Time per Output Token (excl. 1st token)------
Mean TPOT (ms):                          256.68    
Median TPOT (ms):                        275.29    
P99 TPOT (ms):                           541.49    
---------------Inter-token Latency----------------
Mean ITL (ms):                           251.88    
Median ITL (ms):                         96.98     
P99 ITL (ms):                            1892.87   
==================================================
```
